apiVersion: v1
kind: ConfigMap
metadata:
  name: cotoagent-db-init-sql
  namespace: cotoagent
data:
  01-init.sql: |
    -- Try to create pgvector extension, but don't fail if it's not available
    CREATE EXTENSION IF NOT EXISTS vector;

    -- Create users table
    CREATE TABLE IF NOT EXISTS users (
        id SERIAL PRIMARY KEY,
        user_email VARCHAR(50) UNIQUE NOT NULL
    );

    -- Create admin_users table
    CREATE TABLE IF NOT EXISTS admin_users (
        id SERIAL PRIMARY KEY,
        admin_email VARCHAR(50) UNIQUE NOT NULL
    );

    -- Create classes table
    CREATE TABLE IF NOT EXISTS classes (
        id SERIAL PRIMARY KEY,
        classification VARCHAR(255) NOT NULL,
        class_name VARCHAR(255) NOT NULL,
        description TEXT,
        embeddings vector,
        UNIQUE(classification, class_name)
    );

    -- Create races table
    CREATE TABLE IF NOT EXISTS races (
        id SERIAL PRIMARY KEY,
        campaign VARCHAR(255) NOT NULL,
        name VARCHAR(255) NOT NULL,
        description TEXT,
        embeddings vector,
        UNIQUE(campaign, name)
    );

    -- Create spellbooks table
    CREATE TABLE IF NOT EXISTS spellbooks (
        id SERIAL PRIMARY KEY,
        spell_branch VARCHAR(255) NOT NULL,
        book_level VARCHAR(50) NOT NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

    -- Create spells table
    CREATE TABLE IF NOT EXISTS spells (
        id SERIAL PRIMARY KEY,
        spellbook_id INTEGER REFERENCES spellbooks(id) ON DELETE CASCADE,
        spell_name VARCHAR(255) NOT NULL,
        mana_cost VARCHAR(10),
        hit_die VARCHAR(50),
        description TEXT,
        embeddings vector,
        UNIQUE(spell_name)
    );

    -- Create characters table for Discord integration
    CREATE TABLE IF NOT EXISTS characters (
        id SERIAL PRIMARY KEY,
        user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
        name VARCHAR(255) NOT NULL,
        class_name VARCHAR(255),
        class_classification VARCHAR(255),
        race_name VARCHAR(255),
        race_campaign VARCHAR(255),
        strength INTEGER,
        dexterity INTEGER,
        constitution INTEGER,
        intelligence INTEGER,
        wisdom INTEGER,
        charisma INTEGER,
        backstory TEXT,
        notes TEXT,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        last_modified TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        feedback TEXT,
        approval_status VARCHAR(50) DEFAULT 'pending',
        revised BOOLEAN DEFAULT FALSE
    );

    -- Insert default admin user
    INSERT INTO admin_users (admin_email) VALUES ('derpipose@gmail.com') 
    ON CONFLICT (admin_email) DO NOTHING;

    -- Insert default user
    INSERT INTO users (user_email) VALUES ('derpipose@gmail.com') 
    ON CONFLICT (user_email) DO NOTHING;